<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: html_head(pageTitle='Quản lý đơn hàng')"/>

<body>

<!-- container section start -->
<section id="container" class="">
    <header th:replace="fragments :: bar"></header>
    <aside th:replace="fragments :: menu"></aside>
    <!--main content start-->
    <section id="main-content">
        <section class="wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h3 class="page-header" style="font-family: arial;">
                        <i class="fa fa-gift"></i> Danh sách đơn hàng
                    </h3>
                    <ol class="breadcrumb" style="font-family: arial;">
                        <li><a th:href="@{/admin}">Trang chủ</a></li>
                        <li>Đơn hàng</li>
                    </ol>
                </div>
            </div>
            <!-- page start-->
            <div class="row">
                <div class="col-lg-12">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem">
                        <div>
                            <input type="text" id="searchByName" name="searchByName" placeholder="Nhập username...">
                            <input type="button" id="btnSearch" value="Tìm kiếm"/>
                        </div>
                        <div>
                            <label for="status" style="font-weight: bold;">Trạng thái </label>
                            <select id="status" name="status">
                                <option value="1" selected>Chờ xác nhận</option>
                                <option value="2">Chờ lấy hàng</option>
                                <option value="3">Đang giao</option>
                                <option value="4">Đã giao</option>
                                <option value="5">Đã hủy</option>
                                <option value="6">Trả hàng</option>
                            </select>
                        </div>
                        <div style="margin-right: 5rem;">
                            <input type="button" id="viewAll" value="Reset"/>
                        </div>
                    </div>
                    <form id="formSubmit" action="#" method="get">
                        <section class="panel">
                            <table class="table table-striped table-advance table-hover"
                                   style="font-family: arial;">
                                <thead>
                                <th style="text-align: center;">ID</th>
                                <th style="text-align: center;">Name</th>
                                <th style="text-align: center;">Phone</th>
                                <th style="text-align: center;">Email</th>
                                <th style="text-align: center;">Address</th>
                                <th style="text-align: center;">Tổng tiền</th>
                                <th style="text-align: center;">Tổng sản phẩm</th>
                                <th style="text-align: center;">Ngày đặt</th>
                                <th style="text-align: center;">Trạng thái</th>
                                <th colspan="2" style="text-align: center;">Action</th>
                                </thead>
                                <tbody class="row-data">
                                </tbody>
                            </table>
                            <br>
                        </section>
                        <div id="addPagi"></div>
                        <input type="hidden" id="pageNo" name="pageNo" value=""/>
                    </form>
                </div>

            </div>
            <!-- page end-->
            <!--modal-->
            <div class="row col-md-6">
                <form class="chiTietForm">
                    <div class="modal fade" id="chiTietModal" tabindex="-1" role="dialog"
                         aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document" style="width: 700px;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <p class="h4 modal-title" id="maDonHang"></p>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card" style="padding-left: 40px;padding-right: 40px">

                                                <div class="row pb-5 p-5">
                                                    <div class="col-md-6">
                                                        <h5 class="font-weight-bold mb-4">
                                                            <strong>Thông tin khách</strong>
                                                        </h5>
                                                        <p class="mb-1" id="hoTenNguoiNhan"></p>
                                                        <p class="mb-1" id="diaChiNhan"></p>
                                                        <p class="mb-1" id="sdtNhanHang"></p>
                                                    </div>

                                                    <div class="col-md-6 text-right"
                                                         style="text-align: left; padding-left: 100px">
                                                        <h5 class="font-weight-bold mb-4">
                                                            <strong>Thông tin đơn hàng</strong>
                                                        </h5>
                                                        <p class="mb-1" id="trangThaiDonHang"></p>
                                                        <p class="mb-1" id="ngayDatHang"></p>
                                                        <p class="mb-1" id="ngayShipHang"></p>
                                                        <p class="mb-1" id="ngayNhanHang"></p>
                                                    </div>
                                                </div>
                                                <hr/>
                                                <div class="row p-5">
                                                    <div class="col-md-12">
                                                        <table class="table chiTietTable"
                                                               style="text-align: center;">
                                                            <thead>
                                                            <tr>
                                                                <th class="border-0 text-uppercase small font-weight-bold">
                                                                    STT
                                                                </th>
                                                                <th class="border-0 text-uppercase small font-weight-bold">
                                                                    Tên sản phẩm
                                                                </th>
                                                                <th class="border-0 text-uppercase small font-weight-bold">
                                                                    Đơn giá
                                                                </th>
                                                                <th class="border-0 text-uppercase small font-weight-bold">
                                                                    Số lượng đặt
                                                                </th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>

                                                <div class="d-flex flex-row-reverse bg-dark text-white p-4">
                                                    <div class="py-3 px-5 text-right">
                                                        <div class="mb-2">
                                                            <p id="tongTien"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr/>

                                                <div class="col-md-6">
                                                    <h5 class="font-weight-bold mb-4">
                                                        <strong>Thông tin khác</strong>
                                                    </h5>
                                                    <p class="mb-1" id="shipper"></p>
                                                    <p class="mb-1" id="nguoiDat"></p>
                                                    <p id="ghiChu"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div>
                                        <input type="hidden" id="orderId">
                                        <label for="status_details" style="font-weight: bold;">Cập nhật trạng
                                            thái </label>
                                        <select id="status_details" name="status">
                                            <option value="1">Chờ xác nhận</option>
                                            <option value="2">Chờ lấy hàng</option>
                                            <option value="3">Đang giao</option>
                                            <option value="4">Đã giao</option>
                                            <option value="5" selected>Đã hủy</option>
                                            <option value="6">Trả hàng</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-secondary"
                                            data-dismiss="modal">Đóng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>
    </section>
    <!--main content end-->

</section>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/paging/jquery.twbsPagination.js"></script>
<script src="/paging/jquery.twbsPagination.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#viewAll').click(function () {
            ajaxGet(1, 1);
            $('#addPagi').children("#paginationSearch").remove();
            $('#searchByName').val('');
        });

        $("#status").change(function () {
            $("#status option:selected").each(function () {
                let status = $(this).val();
                alert("Ma trang thai : " + status);
                ajaxGet(1, status);
            });
        });

        $("#status_details").change(function () {
            var orderId = $('#orderId').val();
            var confirmation = confirm("Bạn có muốn cập nhật trạng thái đơn hàng ?");
            if (confirmation){
                $("#status_details option:selected").each(function () {
                    let status = $(this).val();
                    updateOrder(orderId,status);
                });
            }
        });

        ajaxGet(1, 1);

        //get contact all
        function ajaxGet(pageNo, status) {
            $.ajax({
                type: "GET",
                contentType: "application/json",
                url: "http://localhost:8080/api/orders/" + pageNo + "/" + status,
                success: function (result) {
                    let pagi = `<ul class="paginationGet" id="paginationGet"></ul>`;
                    $('#addPagi').append(pagi);
                    $('#page').val(pageNo);

                    $('.row-data').html('');
                    $.each(result.content, function (index, orders) {
                        let row = `<tr style="text-align: center;">
                                    <td>${orders.id}</td>
                                    <td>${orders.name}</td>
                                    <td>${orders.phone}</td>
                                    <td>${orders.email}</td>
                                    <td>${orders.address}</td>
                                    <td>${orders.totalCost}</td>
                                    <td>${orders.totalAmount}</td>
                                    <td>${orders.timeOrder}</td>
                                    <td>${orders.status.name}</td>
                                    <td>
                                        <input type="hidden" id="Id_${orders.id}" value="${orders.id}">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-primary btnUpdate">Update</button>
                                            <button type="button" class="btn btn-danger btnXoa">Cancel</button>
                                        </div>
                                    </td>
                                </tr>`;
                        $('.row-data').append(row);
                    });

                    pagination(result.totalPages, pageNo, ajaxGet);

                },
                error: function (e) {
                    alert("Error: ", e);
                    console.log("Error", e);
                }
            });
        };

        function pagination(totalPages, currentPage, ajaxGet) {
            $('#paginationGet').twbsPagination('destroy');
            $('#paginationGet').twbsPagination({
                totalPages: totalPages,
                visiblePages: 3,
                startPage: currentPage,
                onPageClick: function (event, page) {
                    if (currentPage !== page) {
                        ajaxGet(page, 1);
                    }
                }
            });
        };

        $(document).on('click', '#btnSearch', function () {
            var key = $('#searchByName').val();
            if (key.trim() != '') {
                var searchByName = $('#searchByName').val();
                ajaxGetName(1, searchByName);
            } else {
                alert('Bạn chưa nhập từ khóa');
            }
        });

        //search name
        function ajaxGetName(pageNo, searchByName) {
            console.log(searchByName);
            if (searchByName.trim() != '') {
                $.ajax({
                    type: "GET",
                    contentType: "application/json",
                    url: "http://localhost:8080/api/user/" + pageNo + "/" + searchByName,
                    success: function (result) {
                        if (result.totalElements > 0) {
                            $('#addPagi').children("#paginationGet").remove();

                            $('#searchByName').val(searchByName);
                            let pagi = `<ul class="paginationSearch" id="paginationSearch"></ul>`;
                            $('#addPagi').append(pagi);
                            $('#page').val(pageNo);
                            $('#total').val(result.totalPages);

                            $('.row-data').html('');
                            $.each(result.content, function (index, user) {
                                let row = `<tr style="text-align: center;">
                                    <td>${user.id}</td>
                                    <td>${user.userName}</td>
                                    <td>${user.fullName}</td>
                                    <td>${user.email}</td>
                                    <td>${user.phone}</td>
                                    <td>${user.address}</td>
                                    <td>${user.isEnable ? 'Hoạt động' : 'Không hoạt động'}</td>
                                    <td>
                                        <input type="hidden" id="Id_${user.id}" value="${user.id}">
                                        <div class="btn-group">
                                            <a class="btn btn-primary"
                                               href="/admin/user/${user.id}">Update</a>
                                            <a class="btn btn-danger btnxoa">Delete</a>
                                        </div>
                                    </td>
                                </tr>`;
                                $('.row-data').append(row);
                            });

                            paginationName(result.totalPages, pageNo, searchByName, ajaxGetName);
                        } else {
                            alert("Không user nào được tìm thấy với từ khóa " + searchByName);
                            ajaxGet(1);
                            $('#searchByName').val('');
                        }
                    },
                    error: function (e) {
                        alert("Lỗi hệ thống");
                        console.log("Lỗi tìm kiếm");
                    }
                });
            }
        }

        function paginationName(totalPages, currentPage, searchName, ajaxGetName) {
            $('#paginationSearch').twbsPagination('destroy');
            $('#paginationSearch').twbsPagination({
                totalPages: totalPages,
                visiblePages: 3,
                startPage: currentPage,
                onPageClick: function (event, page) {
                    var search = $('#searchByName').val();
                    if (currentPage !== page) {
                        ajaxGetName(page, search);
                    }
                }
            });
        };

        //get info order
        $(document).on("click", ".btnUpdate", function () {
            var orderId = $(this).parent().prev().val();
            $.ajax({
                type: "GET",
                contentType: "application/json",
                url: "http://localhost:8080/api/order/" + orderId,
                success: function (result) {
                    $('#maDonHang').text("Mã đơn hàng: " + result.id);
                    $('#hoTenNguoiNhan').text("Người nhận: " + result.name);
                    $('#sdtNhanHang').text("SĐT: " + result.phone);
                    $('#diaChiNhan').text("Địa chỉ: " + result.address);
                    $('#trangThaiDonHang').text("Trạng thái đơn: " + result.status.name);
                    $('#ngayDatHang').text("Ngày đặt: " + result.timeOrder);
                    $('#orderId').val(result.id);

                    var stt = 1;
                    $.each(result.ordersDetails, function (i, orderdetails) {
                        var chiTietRow = '<tr>' +
                            '<td>' + stt + '</td>' +
                            '<td>' + orderdetails.product.name + '</td>' +
                            '<td>' + orderdetails.price + '</td>' +
                            '<td>' + orderdetails.amount + '</td>';

                        $('.chiTietTable tbody').append(chiTietRow);
                        stt++;
                    });

                    let status_id = result.status.id;

                    $("#status_details option").each(function (i, item) {
                        if (item.value == status_id) {
                            $(`#status_details option[value=${status_id}]`).attr('selected', 'selected');
                        }
                    });

                    $("#chiTietModal").modal();
                },
                error: function (response) {
                    alert("Không tìm thấy đơn hàng " + orderId);
                }
            });
        });

        function updateOrder(ordersId, statusId){
            $.ajax({
                type: "PUT",
                contentType: "application/json",
                url: "http://localhost:8080/api/orders/" + ordersId + "/" + statusId,
                success: function (result) {
                    if (result.id == ordersId){
                        alert("Cập nhật thành công");
                        $('#chiTietModal').modal('hide');
                        ajaxGet(1,1);
                    }
                },
                error: function (e) {
                    alert("Error: ", e);
                    console.log("Error", e);
                }
            });
        }

        //delete contact
        $(document).on("click", ".btnxoa", function () {
            var id = $(this).parent().prev().val();
            var confirmation = confirm("Bạn chắc chắn vô hiệu hóa khoản này ?");
            if (confirmation) {
                $.ajax({
                    type: "DELETE",
                    async: false,
                    contentType: "application/json",
                    url: "http://localhost:8080/api/user/" + id,
                    success: function (result) {
                        if (result.deleted == true) {
                            alert("Vô hiệu hóa thành công tài khoản");
                            $('#searchByName').val('');
                            ajaxGet(1);
                        }
                    },
                    error: function (e) {
                        alert("Error: ", e);
                        console.log("Error", e);
                    }
                });
            }
        });

    });
</script>

</body>
</html>